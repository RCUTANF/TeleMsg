plugins {
    id 'org.springframework.boot' version '3.2.1'
    id 'io.spring.dependency-management' version '1.1.4'
    id 'java'
}

group = 'com.telemsg'
version = '1.0.0'
sourceCompatibility = '21'

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

ext {
    nettyVersion = '4.1.100.Final'
    gsonVersion = '2.10.1'
    mybatisPlusVersion = '3.5.5'
    jjwtVersion = '0.12.3'
}

configurations {
    all {
        // å…¨å±€æ’é™¤å†²çªçš„æ—¥å¿—ä¾èµ–
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
        exclude group: 'ch.qos.logback', module: 'logback-classic'
        exclude group: 'ch.qos.logback', module: 'logback-core'
        exclude group: 'org.slf4j', module: 'slf4j-log4j12'
        exclude group: 'org.slf4j', module: 'slf4j-simple'
        exclude group: 'org.slf4j', module: 'slf4j-jdk14'
        exclude group: 'org.slf4j', module: 'slf4j-nop'
    }
}

dependencies {
    // Spring Boot Starters - logging conflicts are handled globally above
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-websocket'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-cache'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'

    // Use Log4j2 instead of Logback to maintain compatibility with MobileIMSDK
    implementation 'org.springframework.boot:spring-boot-starter-log4j2'

    // SLF4J bridge for Log4j2 (fixes SLF4J binding issue)
    implementation 'org.apache.logging.log4j:log4j-slf4j2-impl:2.21.1'
    implementation 'org.slf4j:slf4j-api:2.0.9'

    // Database
    implementation 'mysql:mysql-connector-java:8.0.33'
    runtimeOnly 'com.h2database:h2'

    // MyBatis Plus for advanced database operations (æ›¿ä»£é»˜è®¤çš„Spring Data JPAä»¥å‡å°‘å†²çª)
    implementation("com.baomidou:mybatis-plus-boot-starter:${mybatisPlusVersion}") {
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-jdbc'
    }

    // Netty for high-performance networking
    implementation "io.netty:netty-all:${nettyVersion}"

    // JSON processing
    implementation "com.google.code.gson:gson:${gsonVersion}"

    // JWT for authentication
    implementation "io.jsonwebtoken:jjwt-api:${jjwtVersion}"
    runtimeOnly "io.jsonwebtoken:jjwt-impl:${jjwtVersion}"
    runtimeOnly "io.jsonwebtoken:jjwt-gson:${jjwtVersion}"

    // Apache Commons
    implementation 'org.apache.commons:commons-lang3'

    // Lombok
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'

    // Development tools
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'

    // Test dependencies
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'

    // Original MobileIMSDK dependency
    implementation fileTree(dir: '../Server/lib', include: ['*.jar'])
}

tasks.named('test') {
    useJUnitPlatform()

    // æµ‹è¯•æ—¶ä½¿ç”¨å¼€å‘é…ç½®
    systemProperty 'spring.profiles.active', 'test'

    // æµ‹è¯•è¾“å‡ºé…ç½®
    testLogging {
        events "passed", "skipped", "failed", "standardOut", "standardError"
        showStandardStreams = false
        exceptionFormat = "full"
    }

    doFirst {
        println "ğŸ§ª è¿è¡ŒTeleMsgå•å…ƒæµ‹è¯•..."
    }
}

// Task to copy resources
task copyResources(type: Copy) {
    from '../'
    into 'src/main/resources'
    include 'README.md'
}

// ==================== æµ‹è¯•å’Œè°ƒè¯•ä»»åŠ¡é…ç½® ====================

// å¼€å‘ç¯å¢ƒè¿è¡Œ (ä½¿ç”¨H2å†…å­˜æ•°æ®åº“)
task runDev(type: JavaExec, group: 'application', description: 'åœ¨å¼€å‘ç¯å¢ƒè¿è¡ŒæœåŠ¡å™¨ (H2æ•°æ®åº“)') {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.telemsg.server.TeleMsgServerApplication'
    args = ['--spring.profiles.active=dev']

    // JVMè°ƒè¯•å‚æ•°
    jvmArgs = [
        '-Xmx1024m',
        '-Xms256m',
        '-XX:+UseG1GC',
        '-Dfile.encoding=UTF-8'
    ]

    // è®¾ç½®ç³»ç»Ÿå±æ€§ï¼Œæ–¹ä¾¿è°ƒè¯•
    systemProperty 'spring.output.ansi.enabled', 'always'
    systemProperty 'logging.level.com.telemsg.server', 'DEBUG'

    // è‡ªåŠ¨é‡å¯æ—¶ä¿æŒJVMå‚æ•°
    if (project.hasProperty('debug')) {
        jvmArgs += ['-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005']
        println "ğŸ”§ è°ƒè¯•æ¨¡å¼å¯ç”¨ï¼Œè°ƒè¯•ç«¯å£: 5005"
    }

    doFirst {
        println "ğŸš€ å¯åŠ¨TeleMsgå¼€å‘æœåŠ¡å™¨..."
        println "ğŸ“Š HTTP API: http://localhost:8080/api"
        println "ğŸ”Œ TCP IMç«¯å£: 8901"
        println "ğŸ’¾ æ•°æ®åº“: H2å†…å­˜æ•°æ®åº“ (http://localhost:8080/h2-console)"
        println "ğŸ“ æ—¥å¿—çº§åˆ«: DEBUG"
        if (project.hasProperty('debug')) {
            println "ğŸ› è°ƒè¯•ç«¯å£: 5005 (IDEAå¯ç›´æ¥é™„åŠ )"
        }
        println "="*50
    }
}

// ç”Ÿäº§ç¯å¢ƒè¿è¡Œ (ä½¿ç”¨MySQLæ•°æ®åº“)
task runProd(type: JavaExec, group: 'application', description: 'åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡ŒæœåŠ¡å™¨ (MySQLæ•°æ®åº“)') {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.telemsg.server.TeleMsgServerApplication'
    args = ['--spring.profiles.active=prod']

    jvmArgs = [
        '-Xmx2048m',
        '-Xms512m',
        '-XX:+UseG1GC',
        '-server'
    ]

    doFirst {
        println "ğŸš€ å¯åŠ¨TeleMsgç”Ÿäº§æœåŠ¡å™¨..."
        println "ğŸ“Š HTTP API: http://localhost:8080/api"
        println "ğŸ”Œ TCP IMç«¯å£: 8901"
        println "ğŸ’¾ æ•°æ®åº“: MySQL (éœ€è¦é¢„å…ˆé…ç½®)"
        println "="*50
    }
}

task runProdDebug(type: JavaExec, group: 'application', description: 'åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡ŒæœåŠ¡å™¨ (DEBUGæ—¥å¿—)') {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.telemsg.server.TeleMsgServerApplication'
    args = [
            '--spring.profiles.active=prod',
            '--logging.level.root=DEBUG',
            '--logging.level.com.telemsg=DEBUG',
            '--logging.level.org.hibernate.SQL=DEBUG',
            '--logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE'
    ]
    jvmArgs = [
            '-Xmx2048m',
            '-Xms512m',
            '-XX:+UseG1GC',
            '-server'
    ]
    doFirst {
        println "ğŸ› å¯åŠ¨TeleMsgç”Ÿäº§æœåŠ¡å™¨ (DEBUGæ¨¡å¼)..."
        println "ğŸ“Š HTTP API: http://localhost:8080/api"
        println "ğŸ”Œ TCP IMç«¯å£: 8901"
        println "ğŸ’¾ æ•°æ®åº“: MySQL"
        println "ğŸ“ æ—¥å¿—çº§åˆ«: DEBUG"
        println "="*50
    }
}

// è°ƒè¯•æ¨¡å¼è¿è¡Œ (å¸¦è°ƒè¯•ç«¯å£)
task runDebug(type: JavaExec, group: 'application', description: 'è°ƒè¯•æ¨¡å¼è¿è¡ŒæœåŠ¡å™¨ (ç«¯å£5005)') {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.telemsg.server.TeleMsgServerApplication'
    args = ['--spring.profiles.active=dev']

    jvmArgs = [
        '-Xmx1024m',
        '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005',
        '-XX:+UseG1GC'
    ]

    doFirst {
        println "ğŸ› å¯åŠ¨TeleMsgè°ƒè¯•æœåŠ¡å™¨..."
        println "ğŸ“Š HTTP API: http://localhost:8080/api"
        println "ğŸ”Œ TCP IMç«¯å£: 8901"
        println "ğŸ› è°ƒè¯•ç«¯å£: 5005"
        println "ğŸ’¡ IDEAè°ƒè¯•: Run -> Attach to Process -> é€‰æ‹©ç«¯å£5005"
        println "="*50
    }
}

// å¿«é€Ÿæµ‹è¯•è¿è¡Œ (æœ€å°åŒ–æ—¥å¿—)
task runQuick(type: JavaExec, group: 'application', description: 'å¿«é€Ÿå¯åŠ¨æµ‹è¯• (æœ€å°åŒ–æ—¥å¿—)') {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.telemsg.server.TeleMsgServerApplication'
    args = [
        '--spring.profiles.active=dev',
        '--logging.level.org.springframework=WARN',
        '--logging.level.org.hibernate=WARN',
        '--spring.jpa.show-sql=false'
    ]

    jvmArgs = ['-Xmx512m', '-XX:+UseG1GC']

    doFirst {
        println "âš¡ å¿«é€Ÿå¯åŠ¨TeleMsgæœåŠ¡å™¨ (æœ€å°åŒ–æ—¥å¿—)..."
        println "ğŸ“Š APIæµ‹è¯•: http://localhost:8080/api/actuator/health"
        println "="*30
    }
}

// APIæµ‹è¯•ä»»åŠ¡
task testApi(group: 'verification', description: 'æµ‹è¯•APIæ¥å£') {
    doLast {
        println "ğŸ§ª APIæµ‹è¯•å‘½ä»¤:"
        println "# å¥åº·æ£€æŸ¥"
        println "curl http://localhost:8080/api/actuator/health"
        println ""
        println "# ç”¨æˆ·æ³¨å†Œ"
        println 'curl -X POST http://localhost:8080/api/users/register \\'
        println '  -H "Content-Type: application/json" \\'
        println '  -d \'{"username":"test","password":"123456","email":"test@example.com"}\''
        println ""
        println "# ç”¨æˆ·ç™»å½•"
        println 'curl -X POST http://localhost:8080/api/users/login \\'
        println '  -H "Content-Type: application/json" \\'
        println '  -d \'{"username":"test","password":"123456"}\''
        println ""
        println "ğŸ’¡ è¯·å…ˆè¿è¡Œ ./gradlew runDev å¯åŠ¨æœåŠ¡å™¨"
    }
}

// æ¸…ç†å’Œé‡ç½®æ•°æ®åº“
task cleanData(group: 'application', description: 'æ¸…ç†H2æ•°æ®åº“æ•°æ®') {
    doLast {
        delete fileTree(dir: '.', include: '**/*.db')
        println "ğŸ§¹ H2æ•°æ®åº“æ•°æ®å·²æ¸…ç†"
    }
}

// æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨ç«¯å£
task showPorts(group: 'help', description: 'æ˜¾ç¤ºæœåŠ¡ç«¯å£ä¿¡æ¯') {
    doLast {
        println "ğŸ”Œ TeleMsgæœåŠ¡ç«¯å£ä¿¡æ¯:"
        println "  HTTP APIç«¯å£:    8080"
        println "  TCP IMç«¯å£:      8901 (å®¢æˆ·ç«¯è¿æ¥)"
        println "  WebSocketç«¯å£:   3000 (Webå®¢æˆ·ç«¯)"
        println "  UDPç«¯å£:         7901"
        println "  è°ƒè¯•ç«¯å£:        5005 (runDebugæ—¶å¯ç”¨)"
        println "  H2æ§åˆ¶å°:       http://localhost:8080/h2-console"
    }
}

// å…¼å®¹åŸæ¥çš„ä»»åŠ¡å
task runServer {
    dependsOn 'runDev'
    group = 'application'
    description = 'è¿è¡ŒæœåŠ¡å™¨ (ç­‰åŒäºrunDev)'
}

// ==================== æ„å»ºé…ç½® ====================

// Build configuration
jar {
    enabled = false
    archiveClassifier = ''
}

bootJar {
    archiveFileName = 'telemsg-server.jar'
    layered {
        enabled = true
    }
}

// ==================== å¸®åŠ©ä¿¡æ¯ ====================

// è‡ªå®šä¹‰å¸®åŠ©ä»»åŠ¡
task helpTeleMsg(group: 'help', description: 'æ˜¾ç¤ºTeleMsgå¸¸ç”¨å‘½ä»¤') {
    doLast {
        println """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    TeleMsg Gradle å‘½ä»¤å¸®åŠ©                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  å¼€å‘æµ‹è¯•å‘½ä»¤:                                              â•‘
â•‘    ./gradlew runDev      - å¼€å‘ç¯å¢ƒè¿è¡Œ (æ¨è)              â•‘  
â•‘    ./gradlew runDebug    - è°ƒè¯•æ¨¡å¼è¿è¡Œ (ç«¯å£5005)          â•‘
â•‘    ./gradlew runQuick    - å¿«é€Ÿå¯åŠ¨ (æœ€å°æ—¥å¿—)              â•‘
â•‘    ./gradlew runProd     - ç”Ÿäº§ç¯å¢ƒè¿è¡Œ                     â•‘
â•‘                                                            â•‘
â•‘  æµ‹è¯•å‘½ä»¤:                                                  â•‘
â•‘    ./gradlew testApi     - æ˜¾ç¤ºAPIæµ‹è¯•å‘½ä»¤                  â•‘
â•‘    ./gradlew test        - è¿è¡Œå•å…ƒæµ‹è¯•                     â•‘
â•‘                                                            â•‘
â•‘  å·¥å…·å‘½ä»¤:                                                  â•‘
â•‘    ./gradlew showPorts   - æ˜¾ç¤ºç«¯å£ä¿¡æ¯                     â•‘
â•‘    ./gradlew cleanData   - æ¸…ç†H2æ•°æ®                      â•‘
â•‘    ./gradlew build       - æ„å»ºé¡¹ç›®                        â•‘
â•‘    ./gradlew bootJar     - æ„å»ºJARåŒ…                       â•‘
â•‘                                                            â•‘
â•‘  è°ƒè¯•æŠ€å·§:                                                  â•‘
â•‘    ./gradlew runDev -Pdebug  - å¼€å‘æ¨¡å¼+è°ƒè¯•ç«¯å£           â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """.stripIndent()
    }
}

